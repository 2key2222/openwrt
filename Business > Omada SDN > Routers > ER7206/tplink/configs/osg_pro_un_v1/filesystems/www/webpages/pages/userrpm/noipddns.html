<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>noipddns</title>
<style type="text/css">
</style>
</head>

<body>
	<div class="func-container" >
		<div id="div_noipddns">
				<div id="noipddnsGrid" class="ddnsSeries">
				</div>
		</div>

		<div id="own_editor">
			<input id="interface" name="interface">
			<input id="name" name="name">
			<input id="passwd" name="passwd">
			<input id="domain" name="domain">
			<input id="interval" name="interval">
			<input id="enable" name="enable">
		</div>

	 	<div id="noipddns_alert_cnt">
			<h4 class="title">
		    	<span class="icon"></span>
		 		<span class="text" id="noipddns_confirm_content"></span>
		 	</h4>
		</div> 

		<span id="ddns_notice" class="hidden"></span>

		<div id="link-detail-window">
	        <table class="link-detail-table detail">
	            <tr>
	                <td class="detail-value"></td>
	            </tr>
	        </table>
	    </div>
		
	 	<div id="noipddns_help"></div>

	</div>
	
<script type="text/javascript">
//<![CDATA[
	try{
	    $
	}catch(e){
	    location.href = "/";
	};

	$(document).ready(function(e){
	var URL_NOIPDDNS = $.su.url("/admin/noipddns?form=noipddns"); //data/virtualServers.json

	//$("span#ddns_notice").html($.su.CHAR.VIRTUAL_SERVERS.ddns_ENABLE_NOTICE);

	$("div.func-container").page({
		title: $.su.CHAR.MENU.NOIPDDNS,//"NO-IP",
		help: ""
	});

	$("div#div_noipddns").panel({
		title: $.su.CHAR.MENU.NOIPDDNS,//"NO-IP",
		collapsible: false
	});
	
	$("input#interface").combobox({
		fieldLabel: $.su.CHAR.PHDDNS.SERVICE_INTERFACE,//"服务接口",
		allowBlank: false,					
		vtype:"string_visible_allow_blank",
		items:[
			{name:"---",value:'---'}
		]
	});
	
	$("input#name").textbox({
		fieldLabel: $.su.CHAR.PHDDNS.USERNAME,//"用户名",
		maxLength:32,
		vtype:"ascii_visible",
		allowBlank:"false",
		tips:"<a target=\"_blank\" href=\"http://www.noip.com\">"+$.su.CHAR.PHDDNS.USERNAME_REGISTER+"</a>"

	});

	$("input#passwd").password({
		fieldLabel: $.su.CHAR.PHDDNS.PASSWORD,//"密码",
		maxLength:32,
		showLevel: false,
        vtype: "password",
		allowBlank:"false"
	});
	$("input#domain").textbox({
		fieldLabel: $.su.CHAR.PHDDNS.DOMAIN_NAME,//"域名",
		maxLength:253,
		allowBlank:"false",
		vtype:"domain"
	});

	$("#interval").combobox({
		fieldLabel: $.su.CHAR.PHDDNS.UPDATE_INTERVAL,
		//labelCls: "l",
		cls: "inline-block",
		allowBlank: false,
		items: [
			{"value": "1h", "name": $.su.CHAR.PHDDNS.ONE_HOUR},
			{"value": "6h", "name": $.su.CHAR.PHDDNS.SIX_HOUR},
			{"value": "12h", "name": $.su.CHAR.PHDDNS.TWETEEN_HOUR},
			{"value": "1d", "name": $.su.CHAR.PHDDNS.ONE_DAY},
			{"value": "2d", "name": $.su.CHAR.PHDDNS.TWO_DAY},
			{"value": "3d", "name": $.su.CHAR.PHDDNS.THREE_DAY},
			{"value": "never", "name": $.su.CHAR.PHDDNS.NEVER}
		]
	});

	$("input#enable").checkbox({
		fieldLabel:$.su.CHAR.USERMNGR.ENABLE,
		defaultValue:["on"],
		items: [
			{boxlabel: $.su.CHAR.VIRTUAL_SERVERS.ENABLE_THIS_ENTRY, uncheckedValue:"off", inputValue: "on", id: "chk_enable",  checked:true}
		]
	});

	var virtualProxy = new $.su.Proxy({
		url: URL_NOIPDDNS
	});

	var $linkDetail = $("#link-detail-window").msg({
        closeBtn: true,
        cls:"l",
        title: $.su.CHAR.PHDDNS.DOMAIN_NAME,//"域名",
        type: "window"
    }).msg("hide");

	function showDetail(domain){
 		var domainString = "";  
		var domainArray = domain.split(';');
		
		for(var i = 0; i < domainArray.length; i++){
			domainString += domainArray[i] + "</br></br>";
		}
		$linkDetail.find(".detail-value").html(domainString).css({
			"lineHeight":"20px",
			"textAlign":"center",
			"wordBreak":"break-all"
		});
        $linkDetail.msg('show');
    }

    window.refresh_interval = window.refresh_interval || 0;
    function ddns_interval(){
    	if(window.refresh_interval){
    	    clearInterval(window.refresh_interval);
    	    window.refresh_interval = 0;
    	}
		window.refresh_interval = setInterval(function(){
			if($("#func-advanced title").text() != "noipddns"){
				clearInterval(window.refresh_interval);
    	    	window.refresh_interval = 0;
    	    	return;
			}
			/*
			var clear_flag = true;
			var data = $("div#noipddnsGrid").grid("getStore").data;
			for (i = 0; i < data.length; i++) {
				var status = Number(data[i].connState);
				if(status == 2 || status >4){
					clear_flag = false;
					break;
				}
			}
			if(clear_flag){
				clearInterval(window.refresh_interval);
    	    	window.refresh_interval = 0;
    	    	return;
			}*/
			//console.log("isEditing "+$(editor).editor("isEditing"));
			$("div#noipddnsGrid").grid("getStore").load();
			
		}, 10000);
    }
    ddns_interval();

    function ddns_timeout(){
    	var timeout = setTimeout(function(){//使用timeout因为后台不会立即修改connState
        	$("div#noipddnsGrid").grid("getStore").load();
        	ddns_interval();
        }, 1000);
    }

	var o = $("div#noipddnsGrid").grid({
		store:{
			proxy: virtualProxy,
			fields: [
			{name: "interface"},
			{name: "name"},
	 		{name: "passwd"},
	 		{name: "interval"},
	 		{name: "enable"},
	 		{name: "connState"},
	 		{name: "domain"},
	 		{name: "t_label"}
			],
			autoLoad: true
		},
		editor: {
			validator:function(){
				var editor  = $(o.grid("getEditor"));
				var interfaceName    = editor.find("#interface").combobox("getValue");
				//console.log(interfaceName);
				var store 	= o.grid("getStore");
				var keyProperty = store.keyProperty;
				var grid_array  = store.data;
				
				var editingId = editor.editor("getEditingId"); 
				if($.isArray(grid_array) && grid_array.length > 0)
				{
					for(var k = 0; k < grid_array.length;k++)
					{
						var data = grid_array[k];
						
						if(data[keyProperty] == editingId)
						{
							continue;
						}
						//interface conflict
						else if(data["interface"] == interfaceName)
						{
							//console.log('conflict interface');
							return false;
						}
					}
				}
				return true;
			},
			content: "#own_editor",
			fields: [
			{name: "interface"},
			{name: "name"},
			{name: "passwd"},
			{name: "domain"},
			{name: "interval"},
			{name: "enable"}
			]

		},
		paging: {
		},
		columns: [
			{
				xtype: "checkcolumn",
				width: 30
			},
			{
				text: $.su.CHAR.PHDDNS.ID,//"序号", 
				xtype: "rownumberer",
				width:40
			},
			{
				text: $.su.CHAR.PHDDNS.SERVICE_INTERFACE,//"服务接口", 
				width:60,
				dataIndex: "interface",
				renderer: function(dd, jindex, data) {
					return data.t_label ? data.t_label : dd;
				}
			},
			{
				text: $.su.CHAR.PHDDNS.USERNAME,//"用户名", 
				width:100,
				dataIndex: "name"
				
			},
			/*{
				text: "密码", 
				width:120,
				dataIndex: "passwd"
				
			},*/
			{
				text: $.su.CHAR.PHDDNS.UPDATE_INTERVAL, 
				width:50,
				dataIndex: "interval",
				renderer: function(v)
				{
					switch(v)
					{
						case '1h' :
							return $.su.CHAR.PHDDNS.ONE_HOUR;
						case '6h' :
							return $.su.CHAR.PHDDNS.SIX_HOUR;
						case '12h' :
							return $.su.CHAR.PHDDNS.TWETEEN_HOUR;
						case '1d' :
							return $.su.CHAR.PHDDNS.ONE_DAY;
						case '2d' :
							return $.su.CHAR.PHDDNS.TWO_DAY;
						case '3d' :
							return $.su.CHAR.PHDDNS.THREE_DAY;
						case 'never' :
							return 	$.su.CHAR.PHDDNS.NEVER;
						default :
							return $.su.CHAR.PHDDNS.NEVER;
					}
				}
				
			},
			{
				text: $.su.CHAR.PHDDNS.START_STOP,//"启用/禁用", 
				width:120,
				dataIndex: "enable",
				xtype: "statuscolumn"
			},
			{
				text: $.su.CHAR.PHDDNS.STATUS,//"状态", 
				width:150,
				dataIndex: "connState",
				renderer: function(v)
				{
					switch(v)
					{
						case '0' :
							return $.su.CHAR.PHDDNS.WARNING3;//'服务已运行';
						case '1' :
							return $.su.CHAR.PHDDNS.WARNING1;//'服务没有运行';
						case '2' :
							return $.su.CHAR.PHDDNS.WARNING2;//'服务正在连接，请稍候';
						case '3' :
							return $.su.CHAR.PHDDNS.WARNING4;//'用户名或密码错误';
						case '4' :
							return $.su.CHAR.PHDDNS.WARNING5;//'域名错误';
						/*case '6' :
						case '7' :
							return '用户名或密码错误';*/
						default :
							return $.su.CHAR.PHDDNS.WARNING2;//'服务正在连接，请稍候';
					}
				}
			},
			{
				text: $.su.CHAR.PHDDNS.DOMAIN_NAME,//"域名", 
				width:150,
				dataIndex: "domain",
				renderer: function(dd, index, data){
					var domainArray= new Array(); 
					var domainString = "";
					if("" == data.domain || typeof data.domain == "undefined"){
						return "---";
					}
					domainArray = data.domain.split(';');
					switch(domainArray.length){
						case 0:
							return "---";
							break;
						case 1:
							return domainArray[0];
							break;
						case 2:
							return domainArray[0] + "</br>" + domainArray[1];
							break;
						default:
							return domainArray[0] + "&nbsp&nbsp" + "<a href='javascript:void(0);' class='btn-detail' data-index='"+ index +"'>"+$.su.CHAR.PHDDNS.DETAIL+"</a>";
							break;
					}        
                }
                /*
				renderer:function(v)
				{
					var domainArray= new Array(); 
					var domainString = "";  
					domainArray = v.split(';');
					
					for(var i = 0; i < domainArray.length; i++){
						domainString += domainArray[i] + "</br>";
					}

					return domainString;
				}
				*/
			},
			{
				xtype: "settings"
			}
		],
		operation: "prompt|add|delete"
	}).on("ev_load", function(e,data, others){
			/*if(others)
			{
				maxrules = others.max_rules;
			}
			var interfaceItem=[];
			var interfaceProxy = new $.su.Proxy({
					url: $.su.url('/admin/interface?form=status'),
					async: false
			});		
			interfaceProxy.read({}, function(data){
				//	console.log("length: "+data.vpn.length);						
				var i
				for (i=0; i<data.normal.length; i++){
					interfaceItem.push({name:data.normal[i].t_label,value:data.normal[i].t_name});						
				}
				//for (i=0; i<data.vpn.length; i++){						
				//	interfaceItem.push({name:data.vpn[i].t_label,value:data.vpn[i].t_name});	
				//}
			});	
			var editor = $("div#noipddnsGrid").grid("getEditor");
			var combobox = $(editor).find('.combobox-value[name=interface]');
				combobox.combobox('loadData',interfaceItem);*/
	}).delegate('a.btn-detail', 'click', function(e){
        var index = $(this).data('index');
        showDetail(o.grid("getStore").data[index].domain);
        //console.log(o.grid("getStore").data[index].domain);
    }).on('ev_update',function(){
    	ddns_interval();  
    }).on('ev_insert',function(){
        ddns_interval();
    }).on('ev_remove',function(){
        ddns_interval();
    });


	var editor = $("div#noipddnsGrid").grid("getEditor");
	$(editor).on("ev_startEdit", function(e, index, key){
		//console.log("index",index)
		if(typeof(index) == "undefined"){
			$(editor).editor("cancelEdit");
            if ($.su.app && $.su.app.errorOperation && $.su.app.errorOperation.denied){
                $.su.app.errorOperation.denied(90000);
            }
            ddns_timeout();
            return;       
        }
        if(window.refresh_interval){
    	    clearInterval(window.refresh_interval);
    	    window.refresh_interval = 0;
    	}

		var ifSelected = {};
		var interfaceItem=[];
		var interfaceProxy = new $.su.Proxy({
				url: $.su.url('/admin/interface?form=status'),
				async: false
		});		
		var data = $("div#noipddnsGrid").grid("getStore").data;
		for (i = 0; i < data.length; i++) {
			ifSelected[data[i]["interface"]] = data[i]["interface"];
		}	
		// delete the selected interfaces from all interfaces
		interfaceProxy.read({}, function(data){				
			for (i=0; i<data.normal.length; i++){
				if (ifSelected[data.normal[i].t_name]) {
					continue;
				}
				if ($.su.func.isLan(data.normal[i].t_name) && data.normal[i].t_name != "LAN") {
					continue
				}
				interfaceItem.push({name:data.normal[i].t_label,value:""+data.normal[i].t_name});						
			}
			/*for (i=0; i<data.vpn.length; i++){						
				if (ifSelected[data.vpn[i].t_name]) {
					continue;
				}
				interfaceItem.push({name:data.vpn[i].t_label,value:""+data.vpn[i].t_name});	
			}*/			
		});	
		if (index != 'add'){
			var noipddnsData = $("div#noipddnsGrid").grid("getStore").getData(key)
			var ifnameItem = noipddnsData['interface'];
			var ifnameLabel= noipddnsData['t_label']
			var ifname = [];
			ifname.push({name:""+ifnameLabel, value:""+ifnameItem, selected:true});
			$(editor).find("#interface").combobox("reset");
			$(editor).find("#interface").combobox("loadData", ifname);
			//$(editor).find("#interface").combobox("disable");
			var ifbox = $(editor).find('.combobox-container');
			//console.log(ifbox[0]);
			$(ifbox[0]).addClass('disabled');
		}
		else {
			$(editor).find("#interface").combobox("enable");
			$(editor).find("#interface").combobox("loadData", interfaceItem);
			$(editor).find("#passwd").password("setValue", "");
		}
	});

	
	$("#noipddns_alert_cnt").msg({
		okHandler:function(){
			$($("div#noipddnsGrid").grid("getEditor")).editor("completeEdit");
		},
		cls:"m warning",
		cancelHandler:function(){
			return true;
		},
		type: "prompt"
	});

	$("#noipddns_confirm_content").html();

	var helpnoipddns = new $.su.Help({
		container: "div#noipddns_help",
		content: "NOIPDDNS"
	});

});
</script>
</body>
</html>
