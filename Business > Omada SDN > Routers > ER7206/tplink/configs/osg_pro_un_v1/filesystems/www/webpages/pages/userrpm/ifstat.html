<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>SYSTEM_ROUTETBL</title>
</head>

<body>
<div class="func-container">

	 <div id="ifstat_list">
	 	<div id="ifstat_list_grid">
	     		
		</div>
		<div id="sort_remind"></div>
		
	 </div>

	 <div id="ifstat_help"></div>
</div>

<script type="text/javascript">
try{
    $
}catch(e){
    location.href = "/";
};

$(document).ready(function(e){
	var URL_STATS_LIST = $.su.url("/admin/ifstat?form=list");
    var list_proxy = new $.su.Proxy({
        url: URL_STATS_LIST,
        /* async: false*/
    });
    $("#ifstat_list").panel({
        title: $.su.CHAR.IFSTAT.TITLE_LIST,
        collapsible: false
    }); 

    var order = "down";

    var interfaceName = [
    	"WAN1",
    	"WAN2",
    	"WAN3",
    	"WAN4",
    	"LAN"
    ];


    function filter(v){
    	if(parseInt(v) > 1024*1024*1024){
    		v = v * 1.0 / (1024*1024*1024);
    		return v.toFixed(1) + "G";
    	}
    	if(parseInt(v) > 1024*1024){
    		v = v * 1.0 / (1024*1024);
    		return v.toFixed(1) + "M";
    	}
    	return v;
    }

    var ifReg = new RegExp(/(eth\d\.?\d{0,})|(ath\d+)|(wifi\d+)|(lo)/);

	var ifstat_grid = $("div#ifstat_list_grid").grid({
		store:{
			proxy: {
				url: URL_STATS_LIST
			},
			fields: [
				{name: "interface"},
                {name: "tx_bps"},
                {name: "rx_bps"},
                {name: "tx_pps"},
                {name: "rx_pps"},
                {name: "tx_bytes"},
				{name: "rx_bytes"},
                {name: "tx_pkts"},
				{name: "rx_pkts"}
			],
			autoLoad: true
		},
		minLines: 0,
		columns: [
			{
				text: $.su.CHAR.GRID.ID, 
				xtype: "rownumberer",
				width:70,
				hidden:true
			},
			{
				text: $.su.CHAR.IFSTAT.ADDR, 
				width:120,
				dataIndex: "interface"
			},
            {
				text: $.su.CHAR.IFSTAT.TX_BPS, 
				width:90,
				dataIndex: "tx_bps"
			},
            {
				text: $.su.CHAR.IFSTAT.RX_BPS, 
				width:90,
				dataIndex: "rx_bps"
			},
            {
				text: $.su.CHAR.IFSTAT.TX_PPS, 
				width:110,
				dataIndex: "tx_pps"
			},
            {
				text: $.su.CHAR.IFSTAT.RX_PPS, 
				width:110,
				dataIndex: "rx_pps"
			},
            {
				text: $.su.CHAR.IFSTAT.TX_BYTES, 
				width:80,
				dataIndex: "tx_bytes",
                renderer: function(v){
                	if(0 == v){
                		return "---";
                	}
                    return filter(v);
                }
			},
			{
				text: $.su.CHAR.IFSTAT.RX_BYTES, 
				width:80,
				dataIndex: "rx_bytes",
                renderer: function(v){
                	if(0 == v){
                		return "---";
                	}
                    return filter(v);
                }
			},
            {
				text: $.su.CHAR.IFSTAT.TX_PKTS, 
				width:80,
				dataIndex: "tx_pkts",
                renderer: function(v){
                	if(0 == v){
                		return "---";
                	}
                    return filter(v);
                }
			},
			{
				text: $.su.CHAR.IFSTAT.RX_PKTS, 
				width:80,
				dataIndex: "rx_pkts",
                renderer: function(v){
                	if(0 == v){
                		return "---";
                	}
                	return filter(v);
                }
			}
		],
		operation: ["clear","refresh","autoRefresh"],
		autoRefresh: true
	}).on("ev_load", function(e){
		var trList = $("tbody.grid-content-data").find("tr");
		$(trList).each(function(i, obj){
			var ifName = $(obj).find("td.grid-content-td-interface").text();
			if(ifReg.test(ifName)){
				$(obj).hide();
			}
		});

		/*
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		console.log(store.data);
		*/
	}).on("ev_clear", function(e, obj, action){
		list_proxy.write({method:'clear'}, function(data){
			ifstat_grid.grid("getStore").load();
		});
	});

	/*
	function dataSort(data, dataIndex, order){
		var tmp = {};
		for(var i = 0; i < data.length; i++){
			for(var j = i + 1; j < data.length - 1; j++){
				if(order == "up"){
					if(parseInt(data[j].dataIndex) > parseInt(data[j+1].dataIndex)){
						tmp = data[j];
						data[j] = data[j+1];
						data[j+1] = tmp;
					}			
				}else{
					if(parseInt(data[j].dataIndex) < parseInt(data[j+1].dataIndex)){
						console.log("down")
						tmp = data[j];
						data[j] = data[j+1];
						data[j+1] = tmp;
					}	
				}	

			}
		}
		console.log(data)
		return data;
	}
	*/
	var dataIndex = "tx_bps";
	function dataSort(x, y) {
		if(order == "down"){
			if(dataIndex == "interface"){
				if (x[dataIndex] > y[dataIndex]) {
	       			return -1;
		    	}else if (x[dataIndex] < y[dataIndex]) {
		       		return 1;
		    	}
			}else{
				if (parseInt(x[dataIndex]) > parseInt(y[dataIndex])) {
	       			return -1;
		    	}else if (parseInt(x[dataIndex]) < parseInt(y[dataIndex])) {
		       		return 1;
		    	}
			}
			
		}else{
			if(dataIndex == "interface"){
				if (x[dataIndex] > y[dataIndex]) {
	       			return 1;
		    	}else if (x[dataIndex] < y[dataIndex]) {
		       		return -1;
		    	}
			}else{
				if (parseInt(x[dataIndex]) > parseInt(y[dataIndex])) {
	       			return 1;
		    	}else if (parseInt(x[dataIndex]) < parseInt(y[dataIndex])) {
		       		return -1;
		    	}
			}
			
		}
	}

	ifstat_grid.delegate("th.grid-header-1", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "interface";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-2", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "tx_bps";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-3", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "rx_bps";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-4", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "tx_pps";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-5", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "rx_pps";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});
	ifstat_grid.delegate("th.grid-header-6", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "tx_bytes";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-7", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "rx_bytes";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-8", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "tx_pkts";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	ifstat_grid.delegate("th.grid-header-9", "click", function(e){
		var store = ifstat_grid.grid("getStore");
		var data = store.data;
		dataIndex = "rx_pkts";
		store.loadData(data.sort(dataSort));
		if(order == "down"){
			order = "up";
		}else{
			order = "down";
		}
	});

	$("th").css({
		"color": "#005564",
		"cursor": "pointer"
	});

	$("#sort_remind").text($.su.CHAR.IFSTAT.TIPS);//"如需要按指定内容排序，请点击表头切换排序方式");
	$(".grid-panel").css("marginBottom","40px");

	var IFSTAT_help = new $.su.Help({
		container: "div#ifstat_help",
		content: ["IFSTAT"]
	});
});
</script>
</body>

</html>
