<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Session Limit</title>
<style type="text/css">
</style>
</head>

<body>
<div class="func-container">
    <div id="function_setting">
        <form id="sessionlimit_settings">
            <input id="sessionlimit_enable" name="status" value=""/>
        </form>
    </div>

    <div id="sessionlimit_rule_list">
        <div id="sessionlimit_rule_grid">
        </div>
    </div>

    <div id="sessionlimit_help"></div>
</div>

<script type="text/javascript">
try{
    $
}catch(e){
    location.href = "/";
};

$(document).ready(function(e){
    var URL_SESSIONLIMIT_ENABLE = $.su.url("/admin/session_limits?form=status"),
        URL_SESSIONLIMIT_RULE_LIST = $.su.url("/admin/session_limits?form=rule_list");

    $("#function_setting").panel({
        title: $.su.CHAR.SESSIONLIMIT.SETTINGS,
        collapsible: false
    });

    var enableProxy = new $.su.Proxy({
        url: URL_SESSIONLIMIT_ENABLE,
        /* async: false*/
    });

    $("#sessionlimit_enable").checkbox({
        /*fieldLabel: $.su.CHAR.SESSIONLIMIT.TITLE,*/
        items: [
            {boxlabel: $.su.CHAR.SESSIONLIMIT.GLOBAL_ENABLE, inputValue: "on", uncheckedValue: "off"}
        ]
   });

   $("#sessionlimit_settings").form({
        proxy: enableProxy,
        fields: [
            {name: "status", mapping: "status"}
        ],
        submitBtn: "default"
    });

    $("#sessionlimit_rule_list").panel({
        title: $.su.CHAR.SESSIONLIMIT.RULE_LIST,
        collapsible: false
    });

    var ruleListProxy = new $.su.Proxy({
        url: URL_SESSIONLIMIT_RULE_LIST
    });


    var ruleGrid = $("#sessionlimit_rule_grid").grid({
        editor: {
            content:"default",
            fields: [
                {name: "name"},
                {name: "ipgroup"},
                {name: "max_conn"},
                {name: "status"}
            ]
        },
        store:{
            proxy: ruleListProxy,
            fields: [
                {name: "name"},
                {name: "ipgroup"},
                {name: "max_conn"},
                {name: "status"}
            ],
            autoLoad: true
        },
        paging:[],
        columns: [
            {
                xtype: "checkcolumn",
                width: $.su.CHAR.SETTING.SESSIONLIMIT.CHECK_COLUMN_WIDTH
            },
            {
                xtype: "rownumberer",
                width: $.su.CHAR.SETTING.SESSIONLIMIT.ROW_NUMBER_WIDTH
            },
            {
                text: $.su.CHAR.SESSIONLIMIT.NAME,
                width: $.su.CHAR.SETTING.SESSIONLIMIT.NAME_WIDTH,
                dataIndex: "name",
                editor: {
                    xtype: "textbox",
                    allowBlank: false,
                    vtype:"name"
                }
            },
            {
                text: $.su.CHAR.SESSIONLIMIT.IPGROUP,
                width: $.su.CHAR.SETTING.SESSIONLIMIT.IPGROUP_WIDTH,
                dataIndex: "ipgroup",
                editor: {
                    xtype: "combobox",
                    allowBlank: false,
                    vtype:"string_visible_allow_blank",
                    items:[
                    {name:"---",value:'---'}
                    ]
                }
            },
            {
                text: $.su.CHAR.SESSIONLIMIT.MAX_CONN,
                width: $.su.CHAR.SETTING.SESSIONLIMIT.MAX_CONN_WIDTH,
                dataIndex: "max_conn",
                editor: {
                    xtype: "textbox",
                    allowBlank: false,
                    maxLength: 6,
                    vtype: {
                        vtype: "number",
                        min: 1,
                        max: 999999
                    },
                    textFormat: function(value) {
                        var num = parseInt(value);
                        if (isNaN(num))
                            return value;
                        else
                            return num;
                    }
                }
            },
            {
                text: $.su.CHAR.SESSIONLIMIT.STATUS,
                width: $.su.CHAR.SETTING.SESSIONLIMIT.ENABLE_WIDTH,
                xtype: "statuscolumn",
                dataIndex: "status",
                editor: {
                    xtype: "checkbox",
                    fieldLabel: '',
                    items: [
                        {boxlabel: $.su.CHAR.SESSIONLIMIT.ENABLE_THIS_ENTRY, inputValue:'on', uncheckedValue:'off', checked:true}
                    ]
                }
            },
            {
                xtype: "settings",
                width: $.su.CHAR.SETTING.SESSIONLIMIT.SETTING_WIDTH
            }
        ],
        operation: 'prompt|add|delete'
    }).on("ev_load", function(e,data, others){
        if(others)/* 通过json里的others参数传递动态阀值 */
        {
			/*保留不用*/
		}
		/*发送form请求,获取ipgroup列表.用于显示于ipgroup下拉框*/
		var ipgroupProxy = new $.su.Proxy({
				url: $.su.url('/admin/ipgroup?form=ipgroup_list'),
				/*url: $.su.url('/admin/ipsec?form=conn'),*/
				async: false
		});
		ipgroupProxy.read({}, function(data){
					var i
					var ipgroupItem=[];
					for (i=0; i< data.length; i++){
                        if (data[i].name == "IPGROUP_ANY"){
                            continue;
                        }
						ipgroupItem.push({name:data[i].name,value:data[i].name});
					}
					var editor = ruleGrid.grid('getEditor');
					var combobox = $(editor).find('.combobox-value[name=ipgroup]');
						combobox.combobox('loadData',ipgroupItem);
		});
    });

    var helpConnlimit = new $.su.Help({
        container: "div#sessionlimit_help",
        content: ["SESSIONLIMIT_ENABLE", "SESSIONLIMIT_LIST"]
    });

});
</script>
</body>

</html>