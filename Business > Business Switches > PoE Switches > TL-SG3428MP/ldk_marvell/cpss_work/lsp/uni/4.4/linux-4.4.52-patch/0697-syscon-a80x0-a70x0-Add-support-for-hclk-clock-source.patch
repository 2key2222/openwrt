From 50f29cc18f3330cf1f8edc06c3bb4abc99008716 Mon Sep 17 00:00:00 2001
From: Shadi Ammouri <shadi@marvell.com>
Date: Tue, 16 Aug 2016 17:38:18 +0300
Subject: [PATCH 0697/2241] syscon: a80x0: a70x0: Add support for hclk clock
 source

This clock is used by AXI-monitor for profiling counters.

Change-Id: Ib77907bd83b7d75c6c443c4dbe7580f5fb2b344f
Signed-off-by: Shadi Ammouri <shadi@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/31987
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: Hanna Hawa <hannah@marvell.com>
---
 .../arm/marvell/ap806-system-controller.txt        |  5 ++-
 arch/arm64/boot/dts/marvell/armada-ap806.dtsi      |  2 +-
 drivers/clk/mvebu/ap806-system-controller.c        | 47 +++++++++++++++++++++-
 3 files changed, 49 insertions(+), 5 deletions(-)

diff --git a/Documentation/devicetree/bindings/arm/marvell/ap806-system-controller.txt b/Documentation/devicetree/bindings/arm/marvell/ap806-system-controller.txt
index 5086b89..6c71da1 100644
--- a/Documentation/devicetree/bindings/arm/marvell/ap806-system-controller.txt
+++ b/Documentation/devicetree/bindings/arm/marvell/ap806-system-controller.txt
@@ -14,6 +14,7 @@ a number of clocks:
  - 1: clock of CPU cluster 1
  - 2: fixed PLL at 1200 Mhz
  - 3: MSS clock, derived from the fixed PLL
+ - 4: AP HCLK, derived from sample-at-reset configuration.
 
 Required properties:
 
@@ -22,13 +23,13 @@ Required properties:
  - reg: register area of the AP806 system controller
  - #clock-cells: must be set to 1
  - clock-output-names: must be defined to:
-    "cpu-cluster-0", "cpu-cluster-1", "fixed", "mss"
+    "cpu-cluster-0", "cpu-cluster-1", "fixed", "mss", "ap-hclk"
 
 Example:
 
 	syscon: system-controller@6f4000 {
 		compatible = "marvell,ap806-system-controller", "syscon";
 		#clock-cells = <1>;
-		clock-output-names = "cpu-cluster-0", "cpu-cluster-1", "fixed", "mss";
+		clock-output-names = "cpu-cluster-0", "cpu-cluster-1", "fixed", "mss", "ap-hclk";
 		reg = <0x6f4000 0x1000>;
 	};
diff --git a/arch/arm64/boot/dts/marvell/armada-ap806.dtsi b/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
index cc4341b..4a24f30 100644
--- a/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
+++ b/arch/arm64/boot/dts/marvell/armada-ap806.dtsi
@@ -295,7 +295,7 @@
 				compatible = "marvell,ap806-system-controller", "syscon";
 				#clock-cells = <1>;
 				clock-output-names = "ap-cpu-cluster-0", "ap-cpu-cluster-1",
-						     "ap-fixed", "ap-mss", "ap-emmc";
+						     "ap-fixed", "ap-mss", "ap-emmc", "ap-hclk";
 				reg = <0x6f4000 0x1000>;
 			};
 
diff --git a/drivers/clk/mvebu/ap806-system-controller.c b/drivers/clk/mvebu/ap806-system-controller.c
index 7a2efde..8c90fb8 100644
--- a/drivers/clk/mvebu/ap806-system-controller.c
+++ b/drivers/clk/mvebu/ap806-system-controller.c
@@ -24,7 +24,7 @@
 #define AP806_SAR_REG			0x400
 #define AP806_SAR_CLKFREQ_MODE_MASK	0x1f
 
-#define AP806_CLK_NUM			5
+#define AP806_CLK_NUM			6
 
 static struct clk *ap806_clks[AP806_CLK_NUM];
 
@@ -35,7 +35,7 @@ static struct clk_onecell_data ap806_clk_data = {
 
 static void __init ap806_syscon_clk_init(struct device_node *np)
 {
-	unsigned int freq_mode, cpuclk_freq;
+	unsigned int freq_mode, cpuclk_freq, hclk_freq;
 	const char *name, *fixedclk_name;
 	struct regmap *regmap;
 	u32 reg;
@@ -85,8 +85,46 @@ static void __init ap806_syscon_clk_init(struct device_node *np)
 		pr_err("invalid SAR value\n");
 	}
 
+	/* Get HCLK frequency */
+	switch (freq_mode) {
+	case 0x4:
+	case 0x10:
+	case 0x14:
+	case 0x19 ... 0x1D:
+		hclk_freq = 400;
+		break;
+	case 0xC:
+		hclk_freq = 600;
+		break;
+	case 0xD:
+	case 0x16:
+		hclk_freq = 525;
+		break;
+	case 0xB:
+	case 0xE:
+	case 0xF:
+		hclk_freq = 450;
+		break;
+	case 0x12:
+	case 0x13:
+	case 0x17:
+		hclk_freq = 325;
+		break;
+	case 0x11:
+	case 0x15:
+		hclk_freq = 800;
+		break;
+	case 0x18:
+		hclk_freq = 650;
+		break;
+	default:
+		hclk_freq = 0;
+		pr_err("invalid SAR value\n");
+	}
+
 	/* Convert to hertz */
 	cpuclk_freq *= 1000 * 1000;
+	hclk_freq *= 1000 * 1000;
 
 	/* CPU clocks depend on the Sample At Reset configuration */
 	of_property_read_string_index(np, "clock-output-names",
@@ -117,6 +155,11 @@ static void __init ap806_syscon_clk_init(struct device_node *np)
 	ap806_clks[4] = clk_register_fixed_factor(NULL, name, fixedclk_name,
 						  0, 1, 3);
 
+	of_property_read_string_index(np, "clock-output-names",
+				      5, &name);
+	ap806_clks[5] = clk_register_fixed_rate(NULL, name, NULL, CLK_IS_ROOT,
+						hclk_freq);
+
 	of_clk_add_provider(np, of_clk_src_onecell_get, &ap806_clk_data);
 }
 
-- 
2.7.4

