From bc044714a7f56080036dc17de566f2c1314a0e7e Mon Sep 17 00:00:00 2001
From: Yelena Krivosheev <yelena@marvell.com>
Date: Mon, 13 Feb 2017 09:57:48 +0200
Subject: [PATCH 1356/2241] net: mvneta: free buffer with wrong high address

Fix potential memory leakage.

Change-Id: I33960935d6f6d59da29ec29cece87fe0580ca272
Signed-off-by: Yelena Krivosheev <yelena@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/36761
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Dmitri Epshtein <dima@marvell.com>
---
 drivers/net/ethernet/marvell/mvneta.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvneta.c b/drivers/net/ethernet/marvell/mvneta.c
index 7eb70bb..f732196 100644
--- a/drivers/net/ethernet/marvell/mvneta.c
+++ b/drivers/net/ethernet/marvell/mvneta.c
@@ -1948,8 +1948,10 @@ static inline int mvneta_rx_refill(struct mvneta_port *pp,
 		return -ENOMEM;
 
 #ifdef CONFIG_64BIT
-	if (unlikely(pp->data_high != ((u64)data & 0xffffffff00000000)))
+	if (unlikely(pp->data_high != ((u64)data & 0xffffffff00000000))) {
+		mvneta_frag_free(pp->frag_size, data);
 		return -ENOMEM;
+	}
 #endif
 
 	phys_addr = dma_map_single(pp->dev->dev.parent, data,
-- 
2.7.4

