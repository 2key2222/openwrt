From 7115bcf539a838fba679db0f503e7152be810904 Mon Sep 17 00:00:00 2001
From: Victor Gu <xigu@marvell.com>
Date: Fri, 9 Dec 2016 16:37:58 +0800
Subject: [PATCH 1396/2241] uart: a3700: add initial PM support

This patch added suspend/resume support for Armada37x0's
primary UART port.
Currently, the UART driver still doesn't support to restore
the configurations, such as baudrate settings and interrupt
mode, etc. And the secondary UART port requires these
additonal configurations.

Change-Id: I8ea8784c3e3b77c8ad98871bc1b0c4d7d248df79
Signed-off-by: Victor Gu <xigu@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/34538
Reviewed-by: Wilson Ding <dingwei@marvell.com>
Tested-by: Wilson Ding <dingwei@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/36506
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
---
 drivers/tty/serial/mvebu-uart.c | 36 ++++++++++++++++++++++++++++++++++++
 1 file changed, 36 insertions(+)

diff --git a/drivers/tty/serial/mvebu-uart.c b/drivers/tty/serial/mvebu-uart.c
index 5db1fa1..bd35658 100644
--- a/drivers/tty/serial/mvebu-uart.c
+++ b/drivers/tty/serial/mvebu-uart.c
@@ -549,6 +549,8 @@ static void mvebu_uart_shutdown(struct uart_port *port)
 
 	writel(0, port->membase + REG_CTRL(uart_data));
 	writel(0, port->membase + uart_data->intr.ctrl_reg);
+
+	free_irq(port->irq, port);
 }
 
 static void mvebu_uart_baud_rate_set(struct uart_port *port, unsigned int baud)
@@ -987,6 +989,37 @@ static int mvebu_uart_remove(struct platform_device *pdev)
 	return 0;
 }
 
+#ifdef CONFIG_PM
+static int mvebu_uart_suspend(struct device *dev)
+{
+	struct mvebu_uart_data *data = dev_get_drvdata(dev);
+
+	if (data->port)
+		uart_suspend_port(&mvebu_uart_driver, data->port);
+
+	device_set_wakeup_enable(dev, true);
+
+	return 0;
+}
+
+static int mvebu_uart_resume(struct device *dev)
+{
+	struct mvebu_uart_data *data = dev_get_drvdata(dev);
+
+	if (data->port)
+		uart_resume_port(&mvebu_uart_driver, data->port);
+
+	device_set_wakeup_enable(dev, false);
+
+	return 0;
+}
+
+static const struct dev_pm_ops mvebu_uart_pm_ops = {
+	.suspend	= mvebu_uart_suspend,
+	.resume		= mvebu_uart_resume,
+};
+#endif
+
 /* Match table for of_platform binding */
 static const struct of_device_id mvebu_uart_of_match[] = {
 	{ .compatible = "marvell,armada-3700-uart",     .data = (void *)REG_UART_A3700     },
@@ -1002,6 +1035,9 @@ static struct platform_driver mvebu_uart_platform_driver = {
 		.owner	= THIS_MODULE,
 		.name  = "mvebu-uart",
 		.of_match_table = of_match_ptr(mvebu_uart_of_match),
+#ifdef CONFIG_PM
+		.pm	= &mvebu_uart_pm_ops,
+#endif
 	},
 };
 
-- 
2.7.4

