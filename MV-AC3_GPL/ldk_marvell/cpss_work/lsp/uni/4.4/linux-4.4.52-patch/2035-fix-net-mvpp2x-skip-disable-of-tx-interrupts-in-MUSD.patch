From bba70ceb9ca0b265eb75ecbc1298aff67de04511 Mon Sep 17 00:00:00 2001
From: Stefan Chulski <stefanc@marvell.com>
Date: Sun, 15 Oct 2017 12:50:17 +0300
Subject: [PATCH 2035/2241] fix: net: mvpp2x: skip disable of tx interrupts in
 MUSDK mode
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- This patch fixes an issue when a MUSDK port modifies the
  platform_device wide interrupt_tx_done attribute.
  It should not do so in any case.
- interrupt_tx_done attribute test should be skipped for Loopback and
  MUSDK ports, that donâ€™t use interrupts
- This patch does not affect normal mvpp2x behavior (w/o musdk patches).
- fixes A7K8K-3242

Change-Id: Ic707e91a819a029b5948df0d668a1ea170378f35
Signed-off-by: Stefan Chulski <stefanc@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/45126
Reviewed-by: Yuval Caduri <cyuval@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
Tested-by: iSoC Platform CI <ykjenk@marvell.com>
Reviewed-by: Omri Itach <omrii@marvell.com>
---
 drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
index 155b029..b6de615 100644
--- a/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
+++ b/drivers/net/ethernet/marvell/mvpp2x/mv_pp2x_main.c
@@ -5163,7 +5163,8 @@ static int mv_pp2x_port_probe(struct platform_device *pdev,
 	mv_pp2x_check_queue_size_valid(port);
 
 	if (mv_pp2_num_cpu_irqs(port) < num_active_cpus() &&
-	    port->interrupt_tx_done) {
+	    port->interrupt_tx_done &&
+	    (!(port->flags & (MVPP2_F_IF_MUSDK | MVPP2_F_LOOPBACK)))) {
 		port->interrupt_tx_done = false;
 		dev_info(&pdev->dev, "mvpp2x: interrupt_tx_done override to false\n");
 	}
-- 
2.7.4

